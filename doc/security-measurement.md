# セキュリティ対策概要

当該リポジトリで実装しているセキュリティ対策の概要

## HTTPS を強制して通信を暗号化（Traefik + Let's Encrypt）
- 何: インターネットとの通信を暗号化し、盗聴や改ざんを防止する。
- なぜ: パスワードや Cookie を守るため。検索エンジンやブラウザの警告回避にも有効である。
- どこ: `cicd/docker-compose.yml` の Traefik 設定で `:80`→`:443` に自動リダイレクトし、Let's Encrypt で証明書を自動取得・更新。
- 補足: 証明書はコンテナ内ボリューム `traefik_data` に保存され、リポジトリには含めない。

## 公開する入口を一つにする（リバースプロキシで分離）
- 何: `n8n` 本体は直接公開せず、Traefik だけをインターネットに公開する。
- なぜ: 露出するコンポーネントを最小化し、攻撃される面を減らす。
- どこ: `n8n` は `127.0.0.1:5678` で待受。外部からのアクセスは Traefik 経由のみ。

## 画面（UI）に Basic 認証をかける（API は除外）
- 何: n8n画面に入る前に ID/パスワードを求める。
- なぜ: 誰でも UI に入れる状態を避けるため。API は Webhook などで使いやすさを優先する。
- どこ: `cicd/docker-compose.yml` の Traefik ラベルで UI 用ルーターに BasicAuth を適用。API ルート（`/rest` と `/webhook`）は除外。
- 注意: API をさらに守りたい場合は、IP 制限や Webhook シークレット/署名、追加の認可を検討する。

## ブラウザに安全な挙動を指示（セキュリティヘッダー）
- 何: HSTS、XSS 対策、MIME スニッフィング防止などのヘッダーを付与する。
- なぜ: 既知の攻撃をブラウザ側で未然に防ぐため。
- どこ: `cicd/docker-compose.yml` のヘッダー設定。
- 注意: HSTS を有効化すると HTTP でのアクセスが効かなくなるため、常に HTTPS を使う運用が前提。

## UI へのレート制限（ブルートフォース軽減）
- 何: UI ルーターに対して 1秒あたり平均10件・最大20件までに制限する。
- なぜ: Basic 認証の総当たりや短時間の過剰アクセスを緩和するため。
- どこ: `cicd/docker-compose.yml` の `n8n-ratelimit` ミドルウェア。
- 注意: 現在は「軽め」の値。攻撃状況やユーザー体験に合わせて調整する。

## SSH はインターネットから閉じる（IAP トンネル経由のみ）
- 何: VM への SSH は Google の IAP 経由に限定し、世界中からの 22/TCP を閉じる。
- なぜ: 無差別な SSH 攻撃（総当たりなど）を避けるため。
- どこ: `terraform/main.tf` の Firewall で送信元を IAP のレンジ `35.235.240.0/20` に限定。Cloud Build は IAP トンネルで接続する。

## 必要最小限の権限（IAM の最小権限）
- 何: サービスアカウントには必要な権限だけを付与する。
- なぜ: 万が一の漏えい時の被害を最小化するため。
- どこ: `terraform/main.tf` で `roles/secretmanager.secretAccessor` など、VM 用/Cloud Build 用 SA に必要最小の権限のみを付与している。